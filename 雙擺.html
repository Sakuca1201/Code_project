<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>混沌之美：雙擺模擬器</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            color: #eee;
            font-family: sans-serif;
            display: flex;
        }
        canvas {
            display: block;
        }
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(20, 20, 20, 0.8);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(5px);
            border: 1px solid #444;
            width: 250px;
        }
        .control-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.9em; margin-bottom: 5px; color: #aaa; }
        input[type="range"] { width: 100%; cursor: pointer; }
        button {
            width: 100%;
            padding: 10px;
            background: #007bff;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }
        button:hover { background: #0056b3; }
        .stats { font-family: monospace; font-size: 0.8em; margin-top: 10px; color: #00ffcc; }
    </style>
</head>
<body>

<div id="controls">
    <h3>雙擺模擬器</h3>
    <div class="control-group">
        <label>重力 (Gravity)</label>
        <input type="range" id="g" min="0" max="2" step="0.1" value="1">
    </div>
    <div class="control-group">
        <label>質量 1 (Mass 1)</label>
        <input type="range" id="m1" min="5" max="50" value="20">
    </div>
    <div class="control-group">
        <label>質量 2 (Mass 2)</label>
        <input type="range" id="m2" min="5" max="50" value="20">
    </div>
    <div class="control-group">
        <label>阻尼 (Damping)</label>
        <input type="range" id="damping" min="0.98" max="1" step="0.0001" value="1">
    </div>
    <button onclick="resetPendulum()">重置擺錘</button>
    <div class="stats" id="info">角度: 0, 0</div>
</div>

<canvas id="canvas"></canvas>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const info = document.getElementById('info');

    let w, h, cx, cy;
    let r1 = 150, r2 = 150;
    let m1 = 20, m2 = 20;
    let a1 = Math.PI / 2, a2 = Math.PI / 2;
    let a1_v = 0, a2_v = 0;
    let g = 1;
    let damping = 1;

    // 儲存軌跡
    let path = [];
    const MAX_PATH = 250; // 軌跡長度（大約幾秒鐘）

    function resize() {
        w = window.innerWidth;
        h = window.innerHeight;
        canvas.width = w;
        canvas.height = h;
        cx = w / 2;
        cy = h / 3;
    }

    window.addEventListener('resize', resize);
    resize();

    function resetPendulum() {
        a1 = Math.PI / 2 + (Math.random() - 0.5) * 0.5;
        a2 = Math.PI / 2 + (Math.random() - 0.5) * 0.5;
        a1_v = 0;
        a2_v = 0;
        path = [];
    }

    function update() {
        // 從界面讀取參數
        g = parseFloat(document.getElementById('g').value);
        m1 = parseFloat(document.getElementById('m1').value);
        m2 = parseFloat(document.getElementById('m2').value);
        damping = parseFloat(document.getElementById('damping').value);

        // 雙擺加速度公式 (Lagrangian Mechanics 推導結果)
        let num1 = -g * (2 * m1 + m2) * Math.sin(a1);
        let num2 = -m2 * g * Math.sin(a1 - 2 * a2);
        let num3 = -2 * Math.sin(a1 - a2) * m2;
        let num4 = a2_v * a2_v * r2 + a1_v * a1_v * r1 * Math.cos(a1 - a2);
        let den = r1 * (2 * m1 + m2 - m2 * Math.cos(2 * a1 - 2 * a2));
        let a1_a = (num1 + num2 + num3 * num4) / den;

        num1 = 2 * Math.sin(a1 - a2);
        num2 = (a1_v * a1_v * r1 * (m1 + m2));
        num3 = g * (m1 + m2) * Math.cos(a1);
        num4 = a2_v * a2_v * r2 * m2 * Math.cos(a1 - a2);
        den = r2 * (2 * m1 + m2 - m2 * Math.cos(2 * a1 - 2 * a2));
        let a2_a = (num1 * (num2 + num3 + num4)) / den;

        // 更新物理狀態
        a1_v += a1_a;
        a2_v += a2_a;
        a1 += a1_v;
        a2 += a2_v;

        // 阻尼
        a1_v *= damping;
        a2_v *= damping;

        // 計算坐標
        let x1 = r1 * Math.sin(a1);
        let y1 = r1 * Math.cos(a1);
        let x2 = x1 + r2 * Math.sin(a2);
        let y2 = y1 + r2 * Math.cos(a2);

        // 記錄軌跡
        path.push({x: x2, y: y2});
        if (path.length > MAX_PATH) path.shift();

        info.innerText = `Angle 1: ${a1.toFixed(2)}, Angle 2: ${a2.toFixed(2)}`;
        
        draw(x1, y1, x2, y2);
        requestAnimationFrame(update);
    }

    function draw(x1, y1, x2, y2) {
        // 清除畫布，帶一點透明度產生殘影感
        ctx.fillStyle = 'rgba(5, 5, 5, 0.2)';
        ctx.fillRect(0, 0, w, h);

        ctx.save();
        ctx.translate(cx, cy);

        // 繪製軌跡
        if (path.length > 1) {
            ctx.beginPath();
            ctx.strokeStyle = '#00ffcc';
            ctx.lineWidth = 2;
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#00ffcc';
            for (let i = 0; i < path.length - 1; i++) {
                ctx.moveTo(path[i].x, path[i].y);
                ctx.lineTo(path[i+1].x, path[i+1].y);
            }
            ctx.stroke();
        }

        // 繪製擺臂
        ctx.shadowBlur = 0;
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 4;
        ctx.lineCap = 'round';
        
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();

        // 繪製節點
        ctx.fillStyle = '#ff3366';
        ctx.beginPath();
        ctx.arc(x1, y1, m1/2, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = '#ffcc00';
        ctx.beginPath();
        ctx.arc(x2, y2, m2/2, 0, Math.PI * 2);
        ctx.fill();

        ctx.restore();
    }

    update();
</script>
</body>
</html>