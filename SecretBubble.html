<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>多人即時牆</title>
    <style>
        body { margin: 0; background: #f0f2f5; font-family: "Microsoft JhengHei", sans-serif; }
        /* 登入畫面 */
        #login-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 30px; border-radius: 15px; text-align: center; }
        
        /* 牆面區域 */
        #wall { display: flex; flex-wrap: wrap; gap: 15px; padding: 20px; padding-bottom: 100px; }
        
        /* 圓角對話框樣式 */
        .msg-card {
            background: white;
            padding: 12px 20px;
            border-radius: 18px; /* 圓角 */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            max-width: 300px;
            border-bottom-left-radius: 2px; /* 像對話框的小尾巴 */
            animation: pop 0.3s ease-out;
        }
        @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .msg-user { font-weight: bold; font-size: 0.8em; color: #555; margin-bottom: 5px; }
        .msg-text { font-size: 1em; color: #333; word-break: break-all; }
        .msg-time { font-size: 0.7em; color: #999; margin-top: 5px; text-align: right; }

        /* 輸入區 */
        #input-area { position: fixed; bottom: 0; width: 100%; background: white; padding: 15px; display: flex; gap: 10px; box-sizing: border-box; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
        #send-btn { background: #0084ff; color: white; border: none; padding: 0 20px; cursor: pointer; border-radius: 20px; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2>請輸入名稱進入 <span id="room-name-display"></span></h2>
        <input type="text" id="username-input" placeholder="你的名稱...">
        <button id="login-btn" onclick="joinRoom()" style="padding: 10px 20px; margin-left: 10px; cursor:pointer;">進入</button>
        <p id="login-error" style="color:red; font-size:0.8em;"></p>
    </div>
</div>

<div id="wall"></div>

<div id="input-area">
    <input type="text" id="msg-input" style="flex:1" placeholder="說點什麼...">
    <button id="send-btn" onclick="sendMessage()">傳送</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, get, child, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBqeC1nFpEEuTcux022t0kaKDUgV3dY1i4",
        authDomain: "bubble-502a8.firebaseapp.com",
        databaseURL: "https://bubble-502a8-default-rtdb.firebaseio.com",
        projectId: "bubble-502a8",
        storageBucket: "bubble-502a8.firebasestorage.app",
        messagingSenderId: "448571231354",
        appId: "1:448571231354:web:b70d4011ec6aa8e0737fc3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- 房間與名稱邏輯 ---
    const urlParams = new URLSearchParams(window.location.search);
    const roomID = urlParams.get('room') || 'public'; // 預設是公共房間
    document.getElementById('room-name-display').innerText = roomID === 'public' ? '公共大廳' : roomID;

    let myName = "";

    window.joinRoom = async function() {
        const nameInput = document.getElementById('username-input');
        const name = nameInput.value.trim();
        const errorEl = document.getElementById('login-error');

        if (!name) return;

        // 檢查名稱是否被佔用 (在該房間內)
        const roomUsersRef = ref(db, `users/${roomID}`);
        const snapshot = await get(child(roomUsersRef, name));
        
        if (snapshot.exists()) {
            errorEl.innerText = "這個名字已經有人用了，換一個吧！";
        } else {
            myName = name;
            document.getElementById('login-overlay').style.display = 'none';
        }
    };

    // --- 訊息邏輯 ---
    const messagesRef = ref(db, `messages/${roomID}`);

    window.sendMessage = function() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if (!text || !myName) return;

        push(messagesRef, {
            user: myName,
            text: text,
            timestamp: serverTimestamp()
        });
        input.value = '';
    };

    onChildAdded(messagesRef, (snapshot) => {
        const data = snapshot.val();
        const wall = document.getElementById('wall');
        
        const date = data.timestamp ? new Date(data.timestamp) : new Date();
        const timeStr = `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;

        const card = document.createElement('div');
        card.className = 'msg-card';
        card.innerHTML = `
            <div class="msg-user">${data.user}</div>
            <div class="msg-text">${data.text}</div>
            <div class="msg-time">${timeStr}</div>
        `;
        wall.appendChild(card);
        window.scrollTo(0, document.body.scrollHeight);
    });
</script>
</body>
</html>